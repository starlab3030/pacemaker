# 사용자 서비스로 구성된 컨테이너 

## 1. 리소스 사전 준비 (예: PostgreSQL)

### 1.1 공유 파일시스템 준비

#### 1.1.1 공유 파일시스템 마운트

개념 설명을 위해 NFS를 이용했으며, 실제 운영환경에서는 SCSI/SAN 기반 공유 볼륨과 SCSI-3PR 권장

```bash
mkdir -pv /redhat/nfs/aap/db
mount -t nfs 192.168.0.3:/starlab/nfs/aap/db /redhat/nfs/aap/db
df -h
```

실행 결과
```
[root@aap-db1 ~]# mkdir -pv /redhat/nfs/aap/db

[root@aap-db1 ~]# mount -t nfs 192.168.0.3:/starlab/nfs/aap/db /redhat/nfs/aap/db

[root@aap-db1 ~]# df -h
Filesystem                       Size  Used Avail Use% Mounted on
devtmpfs                         4.0M     0  4.0M   0% /dev
tmpfs                            3.8G   48M  3.8G   2% /dev/shm
tmpfs                            1.6G  9.3M  1.5G   1% /run
/dev/mapper/rhel-root            114G   11G  104G  10% /
/dev/sda1                        2.0G  417M  1.6G  21% /boot
tmpfs                            769M   56K  769M   1% /run/user/1001
tmpfs                            769M   52K  769M   1% /run/user/42
tmpfs                            769M   36K  769M   1% /run/user/0
192.168.0.3:/starlab/nfs/aap/db  223G   21G  203G  10% /redhat/nfs/aap/db

[root@aap-db1 ~]#
```

#### 1.1.2 PostgreSQL 파일을 위한 디렉터리 설정

NFS v4 이전은 SELinux를 지원하지 않아 권한 설정을 상당히 오픈했으며, 실제 운영환경에서는 최소한의 사용자와 권한으로 설정 권장

```bash
mkdir -pv /redhat/nfs/aap/db/pgsql-data
chmod 777 /redhat/nfs/aap/db/pgsql-data
ls -ld /redhat/nfs/aap/db/pgsql-data/
```
* PostgreSQL 컨테이너의 경우에 내부 사용자와 그룹은 postgres:postgres(26:26) 임

실행 결과
```
[root@aap-db1 ~]# mkdir -pv /redhat/nfs/aap/db/pgsql-data
mkdir: created directory '/redhat/nfs/aap/db/pgsql-data'

[root@aap-db1 ~]# chmod 777 /redhat/nfs/aap/db/pgsql-data

[root@aap-db1 ~]# ls -ld /redhat/nfs/aap/db/pgsql-data/
drwxrwxrwx. 3 root root 22 Oct 17 20:32 /redhat/nfs/aap/db/pgsql-data/

[root@aap-db1 ~]#
```
<br>

### 1.2 PostgreSQL 컨테이너 준비

#### 1.2.1 이미지 준비

로컬에서 이미지 로드
```bash
podman load -i temp/ansible-setup/bundle/images/postgresql-15.tar.gz
```

실행 결과
```
[root@aap-db1 ~]# podman load -i temp/ansible-setup/bundle/images/postgresql-15.tar.gz
Getting image source signatures
Copying blob 4493ee5cf8cf done   |
Copying blob 64d064da291c done   |
Copying blob 8a15e950eb63 done   |
Copying config 2392b56e6b done   |
Writing manifest to image destination
Loaded image: registry.redhat.io/rhel8/postgresql-15:latest

[root@aap-db1 ~]#
```

#### 1.2.2 컨테이너 생성 파일

```bash
cat ~/create-pgsql-for-aap.sh
```

실행 결과
```
[root@aap-db1 ~]# cat ~/create-pgsql-for-aap.sh
#
# Create PostgreSQL container for AAP-DB
#

# Global Env
#
DB_USER=postgres
DB_PASSWD=redhat
ADMIN_PASSWD=redhat

# Create & Start
#
podman run -d --name postgresql \
   -e POSTGRESQL_ADMIN_PASSWORD=$ADMIN_PASSWD \
   -p 5432:5432 \
   -v /redhat/nfs/aap/db/pgsql-data:/var/lib/pgsql/data \
   registry.redhat.io/rhel8/postgresql-15

[root@aap-db1 ~]#
```
* NFS v4 이전 특성상 SELinux를 지원하지 않아, **-v** 옵션에서 *:Z*를 생략

#### 1.2.3 PostgreSQL 컨테이너 생성

```bash
~/create-pgsql-for-aap.sh
podman ps
```

실행 결과
```
[root@aap-db1 ~]# ~/create-pgsql-for-aap.sh
41dfedee9c3901c88094b5fd3c8eb208428014c07e305591fbd25d5fcf98e105

[root@aap-db1 ~]# podman ps
CONTAINER ID  IMAGE                                          COMMAND         CREATED        STATUS        PORTS                   NAMES
41dfedee9c39  registry.redhat.io/rhel8/postgresql-15:latest  run-postgresql  2 seconds ago  Up 2 seconds  0.0.0.0:5432->5432/tcp  postgresql

[root@aap-db1 ~]#
```
<br>

### 1.3 컨테이너를 시스템 서비스로 구성

#### 1.3.1 서비스 파일 생성

```bash
podman generate systemd --new --files --name postgresql
cat ~/container-postgresql.service
```
* ***--new*** 옵션을 사용하여 생성된 유닛 파일은 컨테이너와 Pod가 없다고 가정함

실행 결과
```
[root@aap-db1 ~]# podman generate systemd --new --files --name postgresql

DEPRECATED command:
It is recommended to use Quadlets for running containers and pods under systemd.

Please refer to podman-systemd.unit(5) for details.
/root/container-postgresql.service

[root@aap-db1 ~]# cat ~/container-postgresql.service
# container-postgresql.service
# autogenerated by Podman 4.9.4-rhel
# Thu Oct 17 20:50:44 KST 2024

[Unit]
Description=Podman container-postgresql.service
Documentation=man:podman-generate-systemd(1)
Wants=network-online.target
After=network-online.target
RequiresMountsFor=%t/containers

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
TimeoutStopSec=70
ExecStart=/usr/bin/podman run \
        --cidfile=%t/%n.ctr-id \
        --cgroups=no-conmon \
        --rm \
        --sdnotify=conmon \
        --replace \
        -d \
        --name postgresql \
        -e POSTGRESQL_ADMIN_PASSWORD=redhat \
        -p 5432:5432 \
        -v /redhat/nfs/aap/db/pgsql-data:/var/lib/pgsql/data registry.redhat.io/rhel8/postgresql-15
ExecStop=/usr/bin/podman stop \
        --ignore -t 10 \
        --cidfile=%t/%n.ctr-id
ExecStopPost=/usr/bin/podman rm \
        -f \
        --ignore -t 10 \
        --cidfile=%t/%n.ctr-id
Type=notify
NotifyAccess=all

[Install]
WantedBy=default.target

[root@aap-db1 ~]#
```
* ***--new***옵션 때문에, *podman start* 명령 대신 서비스를 시작할 때 *podman run* 명령을 수행
* ***--cidfile*** 옵션은 컨테이너 ID를 저장하는 경로
* ***%t***는 런타임 디렉터리 루트의 경로 (예: /run/user/$UserID )
* ***%n***은 서비스의 전체 이름

#### 1.3.2 서비스 구성

```bash
cp -Z container-postgresql.service /etc/systemd/system
systemctl daemon-reload
systemctl status container-postgresql.service
```

실행 결과
```
[root@aap-db1 ~]# cp -Z container-postgresql.service /etc/systemd/system

[root@aap-db1 ~]# systemctl daemon-reload

[root@aap-db1 ~]# systemctl status container-postgresql.service
○ container-postgresql.service - Podman container-postgresql.service
     Loaded: loaded (/etc/systemd/system/container-postgresql.service; disabled; preset: disabled)
     Active: inactive (dead)
       Docs: man:podman-generate-systemd(1)

[root@aap-db1 ~]#
```
<br>

### 1.4 방화벽 구성

```bash
firewall-cmd --list-all
firewall-cmd --permanent --zone=public --add-service=postgresql
firewall-cmd --reload
firewall-cmd --list-all
```

실행 결과
```
[root@aap-db1 ~]# firewall-cmd --list-all
public (active)
  target: default
  icmp-block-inversion: no
  interfaces: ens3 ens8
  sources: 
  services: cockpit dhcpv6-client ssh
  ports: 
  protocols: 
  forward: yes
  masquerade: no
  forward-ports: 
  source-ports: 
  icmp-blocks: 
  rich rules: 

[root@aap-db1 ~]# firewall-cmd --permanent --zone=public --add-service=postgresql
success

[root@aap-db1 ~]# firewall-cmd --reload
success

[root@aap-db1 ~]# firewall-cmd --list-all
public (active)
  target: default
  icmp-block-inversion: no
  interfaces: ens3 ens8
  sources: 
  services: cockpit dhcpv6-client postgresql ssh
  ports: 
  protocols: 
  forward: yes
  masquerade: no
  forward-ports: 
  source-ports: 
  icmp-blocks: 
  rich rules: 

[root@aap-db1 ~]#
```
<br>

### 1.5 서비스 테스트

#### 1.5.1 서비스 시작

```bash
systemctl start container-postgresql.service
systemctl status container-postgresql.service
podman ps
```

실행 결과
```
[root@aap-db1 ~]# systemctl start container-postgresql.service

[root@aap-db1 ~]# systemctl status container-postgresql.service
● container-postgresql.service - Podman container-postgresql.service
     Loaded: loaded (/etc/systemd/system/container-postgresql.service; disabled; preset: disabled)
     Active: active (running) since Thu 2024-10-17 20:55:55 KST; 55s ago
       Docs: man:podman-generate-systemd(1)
   Main PID: 37285 (conmon)
      Tasks: 1 (limit: 48800)
     Memory: 1.3M
        CPU: 162ms
     CGroup: /system.slice/container-postgresql.service
             └─37285 /usr/bin/conmon --api-version 1 -c 85e29bc97207621b04f6826e07a040365ce357da96997491043aca27a>

...<snip>...

[root@aap-db1 ~]# podman ps
CONTAINER ID  IMAGE                                          COMMAND         CREATED        STATUS        PORTS                   NAMES
85e29bc97207  registry.redhat.io/rhel8/postgresql-15:latest  run-postgresql  3 seconds ago  Up 3 seconds  0.0.0.0:5432->5432/tcp  postgresql

[root@aap-db1 ~]#
```

#### 1.5.2 컨테이너 상에서 DB 연결

```bash
podman exec -it postgresql /bin/bash --
psql
\l
create database  my_database;
\l
\q
ls -lh /var/lib/pgsql/data/
ls -lh /redhat/nfs/aap/db/pgsql-data/
```

실행 결과
```
[root@aap-db1 ~]# podman exec -it postgresql /bin/bash --

bash-4.4$ psql
psql (15.8)
Type "help" for help.

postgres=# \l
                                                List of databases
   Name    |  Owner   | Encoding |  Collate   |   Ctype    | ICU Locale | Locale Provider |   Access privileges
-----------+----------+----------+------------+------------+------------+-----------------+-----------------------
 postgres  | postgres | UTF8     | en_US.utf8 | en_US.utf8 |            | libc            |
 template0 | postgres | UTF8     | en_US.utf8 | en_US.utf8 |            | libc            | =c/postgres          +
           |          |          |            |            |            |                 | postgres=CTc/postgres
 template1 | postgres | UTF8     | en_US.utf8 | en_US.utf8 |            | libc            | =c/postgres          +
           |          |          |            |            |            |                 | postgres=CTc/postgres
(3 rows)

postgres=# create database  my_database;
CREATE DATABASE

postgres=# \l
                                                 List of databases
    Name     |  Owner   | Encoding |  Collate   |   Ctype    | ICU Locale | Locale Provider |   Access privileges

-------------+----------+----------+------------+------------+------------+-----------------+---------------------
--
 my_database | postgres | UTF8     | en_US.utf8 | en_US.utf8 |            | libc            |
 postgres    | postgres | UTF8     | en_US.utf8 | en_US.utf8 |            | libc            |
 template0   | postgres | UTF8     | en_US.utf8 | en_US.utf8 |            | libc            | =c/postgres
 +
             |          |          |            |            |            |                 | postgres=CTc/postgre
s
 template1   | postgres | UTF8     | en_US.utf8 | en_US.utf8 |            | libc            | =c/postgres
 +
             |          |          |            |            |            |                 | postgres=CTc/postgre
s
(4 rows)

postgres=# \q

bash-4.4$ ls -lh /var/lib/pgsql/data/
total 4.0K
drwx------. 20 postgres postgres 4.0K Oct 17 11:55 userdata

bash-4.4$ exit
exit

[root@aap-db1 ~]# ls -lh /redhat/nfs/aap/db/pgsql-data/
total 4.0K
drwx------. 20 26 26 4.0K Oct 17 21:11 userdata

[root@aap-db1 ~]#
```

#### 1.5.3 호스트에서 DB 연결

```bash
psql --username=postgres --host=aap-db1.thinkmore.net
\l
\q
```

실행 결과
```
[root@aap-db1 ~]# psql --username=postgres --host=aap-db1.thinkmore.net
Password for user postgres:
psql (13.16, server 15.8)
WARNING: psql major version 13, server major version 15.
         Some psql features might not work.
Type "help" for help.

postgres=# \l
                                  List of databases
    Name     |  Owner   | Encoding |  Collate   |   Ctype    |   Access privileges
-------------+----------+----------+------------+------------+-----------------------
 my_database | postgres | UTF8     | en_US.utf8 | en_US.utf8 |
 postgres    | postgres | UTF8     | en_US.utf8 | en_US.utf8 |
 template0   | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +
             |          |          |            |            | postgres=CTc/postgres
 template1   | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +
             |          |          |            |            | postgres=CTc/postgres
(4 rows)

postgres=# \q

[root@aap-db1 ~]#
```

#### 1.5.4 서비스 중지

```bash
systemctl stop container-postgresql.service
systemctl status container-postgresql.service
podman ps -a
```

실행 결과
```
[root@aap-db1 ~]# systemctl stop container-postgresql.service

[root@aap-db1 ~]# systemctl status container-postgresql.service
○ container-postgresql.service - Podman container-postgresql.service
     Loaded: loaded (/etc/systemd/system/container-postgresql.service; disabled; preset: disabled)
     Active: inactive (dead)
       Docs: man:podman-generate-systemd(1)

...<snip>...

[root@aap-db1 ~]# podman ps -a
CONTAINER ID  IMAGE       COMMAND     CREATED     STATUS      PORTS       NAMES

[root@aap-db1 ~]#
```
* 서비스 파일 생성 시 ***--new*** 옵션을 지정하였기 때문에 서비스 정지 시 컨테이너가 제거됨
<br>

### 1.6 클러스터 멤버 노드 구성

> [!NOTE]
> 멤버 노드 중에서 PostgreSQL 서비스로 고가용성 구성할 노드는 같은 작업을 반복합니다.
<br>
<br>

## 2. 리소스 그룹 생성

### 2.1 클러스터 상태 확인

```bash
pcs cluster status
```

실행 결과
```
[root@aap-db1 ~]# pcs cluster status
Cluster Status:
 Cluster Summary:
   * Stack: corosync (Pacemaker is running)
   * Current DC: aap-db1.thinkmore.net (version 2.1.7-5.2.el9_4-0f7f88312) - partition with quorum
   * Last updated: Thu Oct 17 19:21:34 2024 on aap-db2.thinkmore.net
   * Last change:  Thu Oct 17 19:19:54 2024 by hacluster via hacluster on aap-db1.thinkmore.net
   * 2 nodes configured
   * 0 resource instances configured
 Node List:
   * Online: [ aap-db1.thinkmore.net aap-db2.thinkmore.net ]

PCSD Status:
  aap-db2.thinkmore.net: Online
  aap-db1.thinkmore.net: Online

[root@aap-db1 ~]# 
```

### 2.2 VIP와 함께 리소스 그룹 생성

#### 2.2.1 VIP 리소스 생성

```bash
pcs resource create pgsql-vip ocf:heartbeat:IPaddr2 ip=192.168.0.47 cidr_netmask=24 nic=ens3 --group pgsql-group
pcs resource status
```

실행 결과
```
[root@aap-db1 ~]# pcs resource create pgsql-vip ocf:heartbeat:IPaddr2 ip=192.168.0.47 cidr_netmask=24 nic=ens3 --group pgsql-group

[root@aap-db1 ~]# pcs resource status
  * Resource Group: pgsql-group:
    * pgsql-vip (ocf:heartbeat:IPaddr2):         Started aap-db1.thinkmore.net

[root@aap-db1 ~]#
```
* VIP 192.168.0.47이 app-db1.thinkmore.net 노드의 ens3 네트워크 인터페이스 상에 있음

### 2.2.2 가상 IP 확인

```bash
ip --br a s ens3
```

실행 결과
```
[root@aap-db1 ~]# ip --br a s ens3
ens3             UP             192.168.0.48/24 192.168.0.47/24 fe80::5054:ff:fe36:6a2e/64

[root@aap-db1 ~]#
```
<br>

### 2.3 systemd 리소스 구성

#### 2.3.1 PostgreSQL 서비스 리소스 생성

```bash
pcs resource create pgsql-service systemd:container-postgresql.service 
pcs resource status
```

실행 결과
```
[root@aap-db1 ~]# pcs resource create pgsql-service systemd:container-postgresql.service --group pgsql-group

[root@aap-db1 ~]# pcs resource status
  * Resource Group: pgsql-group:
    * pgsql-vip (ocf:heartbeat:IPaddr2):         Started aap-db1.thinkmore.net
    * pgsql-service     (systemd:container-postgresql.service):  Started aap-db1.thinkmore.net

[root@aap-db1 ~]#
```
* PostgreSQL 서비스가 aap-db1.thinkmore.net에서 실행 중

#### 2.3.2 systemd 리소스 접속 확인

VIP로 PostgreSQL 서비스 연결 테스트
```bash
podman ps
psql --username=postgres --host=192.168.0.47
\l
\q
```

실행 결과
```
[root@aap-db1 ~]# podman ps
CONTAINER ID  IMAGE                                          COMMAND         CREATED        STATUS        PORTS                   NAMES
bddc01b38dd9  registry.redhat.io/rhel8/postgresql-15:latest  run-postgresql  4 minutes ago  Up 4 minutes  0.0.0.0:5432->5432/tcp  postgresql

[root@aap-db1 ~]# psql --username=postgres --host=192.168.0.47
Password for user postgres:
psql (13.16, server 15.8)
WARNING: psql major version 13, server major version 15.
         Some psql features might not work.
Type "help" for help.

postgres=# \l
                                  List of databases
    Name     |  Owner   | Encoding |  Collate   |   Ctype    |   Access privileges
-------------+----------+----------+------------+------------+-----------------------
 my_database | postgres | UTF8     | en_US.utf8 | en_US.utf8 |
 postgres    | postgres | UTF8     | en_US.utf8 | en_US.utf8 |
 template0   | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +
             |          |          |            |            | postgres=CTc/postgres
 template1   | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +
             |          |          |            |            | postgres=CTc/postgres
(4 rows)

postgres=# \q

[root@aap-db1 ~]#
```
<br>
<br>

## 3. 리소스 그룹 이동 테스트

### 3.1 리소스 그룹 이동

리소스 그룹을 aap-db1.thinkmore.net에서 aap-db2.thinkmore.net으로 이동
```bash
pcs resource status
pcs resource move pgsql-group --autodelete
pcs resource status
```

실행 결과
```
[root@aap-db1 ~]# pcs resource status
  * Resource Group: pgsql-group:
    * pgsql-vip (ocf:heartbeat:IPaddr2):         Started aap-db1.thinkmore.net
    * pgsql-service     (systemd:container-postgresql.service):  Started aap-db1.thinkmore.net

[root@aap-db1 ~]# pcs resource move pgsql-group --autodelete
Location constraint to move resource 'pgsql-group' has been created
Waiting for the cluster to apply configuration changes...
Location constraint created to move resource 'pgsql-group' has been removed
Waiting for the cluster to apply configuration changes...
resource 'pgsql-group' is running on node 'aap-db2.thinkmore.net'

[root@aap-db1 ~]# pcs resource status
  * Resource Group: pgsql-group:
    * pgsql-vip (ocf:heartbeat:IPaddr2):         Started aap-db2.thinkmore.net
    * pgsql-service     (systemd:container-postgresql.service):  Started aap-db2.thinkmore.net

[root@aap-db1 ~]#
```
<br>

### 3.2 VIP 확인

VIP 연결 테스트
```bash
ping -c 2 192.168.0.47
ssh aap-db2.thinkmore.net "ip --br a s ens3"
```

실행 결과
```
[root@aap-db1 ~]# ping -c 2 192.168.0.47
PING 192.168.0.47 (192.168.0.47) 56(84) bytes of data.
64 bytes from 192.168.0.47: icmp_seq=1 ttl=64 time=0.582 ms
64 bytes from 192.168.0.47: icmp_seq=2 ttl=64 time=0.814 ms

--- 192.168.0.47 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1019ms
rtt min/avg/max/mdev = 0.582/0.698/0.814/0.116 ms

[root@aap-db1 ~]# ssh aap-db2.thinkmore.net "ip --br a s ens3"
ens3             UP             192.168.0.49/24 192.168.0.47/24 fe80::5054:ff:fe71:9f59/64

[root@aap-db1 ~]#
```
<br>

### 3.3 원격(VIP)로 PostgreSQL 연결 테스트

aap-db2.thinkmore.net에서 실행 중인 서비스에 연결
```bash
psql --username=postgres --host=192.168.0.47
\l
\q
```

실행 결과
```
[root@aap-db1 ~]# psql --username=postgres --host=192.168.0.47
Password for user postgres:
psql (13.16, server 15.8)
WARNING: psql major version 13, server major version 15.
         Some psql features might not work.
Type "help" for help.

postgres=# \l
                                  List of databases
    Name     |  Owner   | Encoding |  Collate   |   Ctype    |   Access privileges
-------------+----------+----------+------------+------------+-----------------------
 my_database | postgres | UTF8     | en_US.utf8 | en_US.utf8 |
 postgres    | postgres | UTF8     | en_US.utf8 | en_US.utf8 |
 template0   | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +
             |          |          |            |            | postgres=CTc/postgres
 template1   | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +
             |          |          |            |            | postgres=CTc/postgres
(4 rows)

postgres=# \q

[root@aap-db1 ~]#
```
<br>
<br>

------
[차례](../README.md)